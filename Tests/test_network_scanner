import pytest
import asyncio
from unittest.mock import patch, AsyncMock, MagicMock
from typer.testing import CliRunner
import socket
from chimera_intel.core.network_scanner import (
    network_scan_app,
    _probe_port,
    _resolve_target_ip,
)
from chimera_intel.core.schemas import PortScanResult, ServiceBanner

runner = CliRunner()


@pytest.mark.asyncio
@patch("asyncio.get_event_loop")
async def test_resolve_target_ip(mock_get_event_loop):
    """Tests successful IP resolution."""
    mock_loop = MagicMock()
    mock_loop.getaddrinfo = AsyncMock(
        return_value=[
            (
                socket.AF_INET,
                socket.SOCK_STREAM,
                6,
                "",
                ("127.0.0.1", 0),
            )
        ]
    )
    mock_get_event_loop.return_value = mock_loop

    ip = await _resolve_target_ip("localhost")
    assert ip == "127.0.0.1"
    mock_loop.getaddrinfo.assert_called_with("localhost", None, family=socket.AF_INET)


@pytest.mark.asyncio
@patch("asyncio.open_connection")
async def test_probe_port_open_with_banner(mock_open_connection):
    """Tests a port that is open and returns a banner."""
    mock_reader = AsyncMock()
    mock_reader.read = AsyncMock(return_value=b"HTTP/1.1 200 OK\r\nServer: test\r\n\r\n")
    mock_writer = AsyncMock()
    mock_open_connection.return_value = (mock_reader, mock_writer)

    result = await _probe_port("127.0.0.1", 80)

    assert result.is_open is True
    assert result.port == 80
    assert result.service is not None
    assert result.service.name == "http"  # 80 is a common port
    assert result.service.banner == "HTTP/1.1 200 OK"
    mock_writer.write.assert_called_with(b"HEAD / HTTP/1.0\r\n\r\n")


@pytest.mark.asyncio
@patch("asyncio.open_connection", new_callable=AsyncMock)
async def test_probe_port_closed(mock_open_connection):
    """Tests a port that is closed (ConnectionRefusedError)."""
    mock_open_connection.side_effect = ConnectionRefusedError

    result = await _probe_port("127.0.0.1", 22)
    assert result.is_open is False
    assert result.port == 22
    assert result.service is None


@pytest.mark.asyncio
@patch("asyncio.open_connection", new_callable=AsyncMock)
async def test_probe_port_timeout(mock_open_connection):
    """Tests a port that times out."""
    mock_open_connection.side_effect = asyncio.TimeoutError

    result = await _probe_port("1.2.3.4", 445, timeout=0.1)
    assert result.is_open is False
    assert result.port == 445


@patch("chimera_intel.core.project_manager.resolve_target", return_value="example.com")
@patch(
    "chimera_intel.core.network_scanner._resolve_target_ip",
    return_value="93.184.216.34",
)
@patch("chimera_intel.core.network_scanner.run_port_scan")
@patch("chimera_intel.core.network_scanner.save_or_print_results")
@patch("chimera_intel.core.network_scanner.save_scan_to_db")
def test_run_cli_command(
    mock_save_db,
    mock_save_print,
    mock_run_scan,
    mock_resolve_ip,
    mock_resolve_target,
):
    """Tests the Typer CLI command."""
    mock_open_port = PortScanResult(
        port=80,
        is_open=True,
        service=ServiceBanner(name="http", banner="Test Server"),
    )
    mock_report = MagicMock()
    mock_report.model_dump.return_value = {"ip": "93.184.216.34", "open_ports": [80]}
    mock_run_scan.return_value = mock_report

    result = runner.invoke(
        network_scan_app, ["run", "example.com", "--ports", "80,443"]
    )

    assert result.exit_code == 0
    assert "Starting network scan for [cyan]93.184.216.34[/cyan]" in result.stdout
    assert "Network scan complete for example.com" in result.stdout
    mock_resolve_target.assert_called_with("example.com", required_assets=["domain", "ip"])
    mock_resolve_ip.assert_called_with("example.com")
    mock_run_scan.assert_called_with("93.184.216.34", [80, 443])
    mock_save_print.assert_called_with({"ip": "93.184.216.34", "open_ports": [80]}, None)
    mock_save_db.assert_called_with(
        target="example.com",
        module="network_scanner",
        data={"ip": "93.184.216.34", "open_ports": [80]},
    )