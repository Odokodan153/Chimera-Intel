import unittest
from unittest.mock import patch, MagicMock
from httpx import Response, RequestError

from chimera_intel.core.malware_sandbox import get_sandbox_report
from chimera_intel.core.schemas import SandboxResult


class TestMalwareSandbox(unittest.TestCase):
    """Test cases for the Malware Sandbox module."""

    @patch("chimera_intel.core.malware_sandbox.sync_client.get")
    def test_get_sandbox_report_malicious(self, mock_get):
        """Tests retrieving a report for a known malicious file."""
        # --- Arrange ---
        mock_hash = "a" * 64  # Mock SHA256 hash
        mock_response = MagicMock(spec=Response)
        mock_response.raise_for_status.return_value = None
        mock_response.status_code = 200
        mock_response.json.return_value = {
            "file_info": {"name": "evil.exe", "type": "PE32"},
            "is_malicious": True,
            "malware_family": "Emotet",
            "confidence_score": 0.95,
            "behaviors": [
                {
                    "category": "network",
                    "description": "Contacts C2 server at 1.2.3.4",
                    "ttp_id": "T1071",
                    "risk": "MALICIOUS",
                },
                {
                    "category": "filesystem",
                    "description": "Drops file in C:\\Users\\Admin\\AppData",
                    "ttp_id": "T1547.001",
                    "risk": "SUSPICIOUS",
                },
            ],
        }
        mock_get.return_value = mock_response

        # --- Act ---
        with patch("chimera_intel.core.malware_sandbox.API_KEYS.sandbox_api_key", "fake_key"):
            result = get_sandbox_report(mock_hash)

        # --- Assert ---
        self.assertIsInstance(result, SandboxResult)
        self.assertIsNone(result.error)
        self.assertTrue(result.is_malicious)
        self.assertEqual(result.malware_family, "Emotet")
        self.assertEqual(result.file_details.filename, "evil.exe")
        self.assertEqual(len(result.observed_behaviors), 2)
        self.assertEqual(result.observed_behaviors[0].risk_level, "MALICIOUS")

    @patch("chimera_intel.core.malware_sandbox.sync_client.get")
    def test_get_sandbox_report_clean(self, mock_get):
        """Tests retrieving a report for a known clean file."""
        # --- Arrange ---
        mock_hash = "b" * 64
        mock_response = MagicMock(spec=Response)
        mock_response.raise_for_status.return_value = None
        mock_response.status_code = 200
        mock_response.json.return_value = {
            "file_info": {"name": "clean.dll", "type": "PE32"},
            "is_malicious": False,
            "confidence_score": 0.99,
            "behaviors": [],
        }
        mock_get.return_value = mock_response

        # --- Act ---
        with patch("chimera_intel.core.malware_sandbox.API_KEYS.sandbox_api_key", "fake_key"):
            result = get_sandbox_report(mock_hash)

        # --- Assert ---
        self.assertIsInstance(result, SandboxResult)
        self.assertIsNone(result.error)
        self.assertFalse(result.is_malicious)
        self.assertIsNone(result.malware_family)
        self.assertEqual(len(result.observed_behaviors), 0)

    @patch("chimera_intel.core.malware_sandbox.sync_client.get")
    def test_get_sandbox_report_not_found(self, mock_get):
        """Tests handling of a 404 (report not found) response."""
        # --- Arrange ---
        mock_hash = "c" * 64
        mock_response = MagicMock(spec=Response)
        mock_response.status_code = 404
        mock_get.return_value = mock_response

        # --- Act ---
        with patch("chimera_intel.core.malware_sandbox.API_KEYS.sandbox_api_key", "fake_key"):
            result = get_sandbox_report(mock_hash)

        # --- Assert ---
        self.assertIsInstance(result, SandboxResult)
        self.assertIsNotNone(result.error)
        self.assertIn("No report found", result.error)

    def test_get_sandbox_report_no_api_key(self):
        """Tests that the function returns an error if the API key is not set."""
        with patch("chimera_intel.core.malware_sandbox.API_KEYS.sandbox_api_key", None):
            result = get_sandbox_report("d" * 64)
            
        self.assertIsInstance(result, SandboxResult)
        self.assertIsNotNone(result.error)
        self.assertIn("SANDBOX_API_KEY) is not configured", result.error)

    @patch("chimera_intel.core.malware_sandbox.sync_client.get")
    def test_get_sandbox_report_api_error(self, mock_get):
        """Tests error handling during an API failure."""
        mock_get.side_effect = RequestError("Connection timed out")
        
        with patch("chimera_intel.core.malware_sandbox.API_KEYS.sandbox_api_key", "fake_key"):
            result = get_sandbox_report("e" * 64)
            
        self.assertIsInstance(result, SandboxResult)
        self.assertIn("An API error occurred", result.error)

if __name__ == "__main__":
    unittest.main()