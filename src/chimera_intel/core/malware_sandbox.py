"""
Module for Malware Behavior Sandbox integration.

Handles the submission of suspicious files (by hash or upload) to
an automated sandbox and retrieves the behavior analysis report.
"""

import logging
from typing import Optional
import typer
from .config_loader import API_KEYS
from .database import save_scan_to_db
from .http_client import sync_client
from .schemas import SandboxFile, SandboxBehavior, SandboxResult
from .utils import console, save_or_print_results

logger = logging.getLogger(__name__)

# In a real implementation, this would point to a service like
# VirusTotal, Hybrid Analysis, Cuckoo, etc.
SANDBOX_API_URL = "https://api.mock-sandbox.com/v1/report"


def get_sandbox_report(file_hash: str) -> SandboxResult:
    """
    Fetches a sandbox analysis report for a given file hash (SHA256).

    This function simulates fetching a pre-computed report.
    A full implementation would also include a POST endpoint to submit
    new files for analysis.
    """
    api_key = API_KEYS.sandbox_api_key  # Assumes a SANDBOX_API_KEY in config
    if not api_key:
        return SandboxResult(
            file_details=SandboxFile(file_hash=file_hash),
            error="Sandbox API key (SANDBOX_API_KEY) is not configured.",
        )
    
    logger.info(f"Fetching sandbox report for hash: {file_hash}")
    
    headers = {"X-API-KEY": api_key}
    params = {"hash": file_hash}

    try:
        response = sync_client.get(SANDBOX_API_URL, headers=headers, params=params)
        
        if response.status_code == 404:
            return SandboxResult(
                file_details=SandboxFile(file_hash=file_hash),
                error=f"No report found for hash '{file_hash}'. File may need to be submitted first.",
            )
            
        response.raise_for_status()
        data = response.json()

        file_details = SandboxFile(
            file_hash=file_hash,
            filename=data.get("file_info", {}).get("name", "N/A"),
            file_type=data.get("file_info", {}).get("type", "Unknown"),
        )
        
        observed_behaviors = [
            SandboxBehavior(
                category=b.get("category", "unknown"),
                description=b.get("description", "No description."),
                mitre_ttp_id=b.get("ttp_id"),
                risk_level=b.get("risk", "INFO").upper(),
            )
            for b in data.get("behaviors", [])
        ]

        return SandboxResult(
            file_details=file_details,
            is_malicious=data.get("is_malicious", False),
            malware_family=data.get("malware_family"),
            confidence_score=data.get("confidence_score", 0.0),
            observed_behaviors=observed_behaviors,
        )

    except Exception as e:
        logger.error(f"An error occurred while querying sandbox API: {e}")
        return SandboxResult(
            file_details=SandboxFile(file_hash=file_hash),
            error=f"An API error occurred: {e}",
        )


# --- Typer CLI Application ---

sandbox_app = typer.Typer()

@sandbox_app.command("analyze")
def run_sandbox_analysis(
    file_hash: str = typer.Argument(
        ..., help="The SHA256 hash of the file to analyze."
    ),
    output_file: Optional[str] = typer.Option(
        None, "--output", "-o", help="Save results to a JSON file."
    ),
):
    """
    Retrieves a malware sandbox analysis report for a file hash.
    (Note: Assumes the file has already been submitted to the sandbox).
    """
    with console.status(
        f"[bold cyan]Analyzing file hash '{file_hash}'...[/bold cyan]"
    ):
        results_model = get_sandbox_report(file_hash)
    
    results_dict = results_model.model_dump(exclude_none=True)
    save_or_print_results(results_dict, output_file)
    save_scan_to_db(target=file_hash, module="malware_sandbox", data=results_dict)